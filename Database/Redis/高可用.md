# 主从复制
master 节点可以读写, replica 节点只读
数据修改只在主节点进行, 将数据同步到从节点
## 第一次同步
```sh
replicaof <master-ip> <master-port>
```
![ea4f7e86baf2435af3999e5cd38b6a26-1.webp](https://raw.githubusercontent.com/hmmm42/Picbed/main/obsidian/picturesea4f7e86baf2435af3999e5cd38b6a26-1.webp)
### 经理节点
从节点执行 `replicaof <replica-ip> <replica-port>` 命令 
![4d850bfe8d712d3d67ff13e59b919452.webp](https://raw.githubusercontent.com/hmmm42/Picbed/main/obsidian/pictures4d850bfe8d712d3d67ff13e59b919452.webp)
## 命令传播
基于长连接 主节点将 **写操作** 命令推送到从节点
## 增量复制
网络断开后恢复, 将增量数据发送到从节点
- replication buffer: 每个从节点都有一个, 全量,增量复制都有
- repl backlog buffer: 一个主节点只有一个

# 哨兵
实现 **主从节点故障转移**, 主节点挂掉, 哨兵会选举一个从节点作为新的主节点
## 机制
哨兵每秒向所有主从节点发送心跳, 如果规定时间内没有收到心跳, 认为节点主观下线
- 主观下线: 主, 从
- 客观下线: 主, 一个哨兵认为主节点主观下线后, 向其他哨兵发起投票, 继续判断
## 故障转移
认为客观下线的哨兵成为哨兵 leader
`quorum`应该设置为哨兵数量的一半+1
### 选举主节点
排除已下线, 网络状态不好的节点
三轮考察:
1. 节点优先级 (手动设置)
2. 复制进度, 优先选从主节点复制多的
3. 节点ID, ID较小优先
哨兵 leader 向选举出的从节点发送 `slaveof no one` 命令, 让其成为主节点
### 将从节点指向新主节点
哨兵 leader 向其他从节点发送 `slaveof <new-master-ip> <new-master-port>` 命令
### 通知客户端
基于 pub/sub 机制
### 将旧主节点设置为从节点
哨兵持续监视旧主节点, 如果恢复, 将其设置为从节点
## 集群组成
基于 pub/sub 机制, 通过主节点感知其他哨兵, 向主节点发送`INFO`命令, 获取从节点信息 
# cluster 集群